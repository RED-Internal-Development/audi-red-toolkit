name: Audi RED Data Collection

on:
    workflow_call:
        inputs:
            jest_coverage_artifact:
                description: 'jest artifact name when uploaded'
                required: true
                type: string
            lighthouse_coverage_artifact:
                description: 'lighthouse artifact name when uploaded'
                required: true
                type: string

jobs:
    jest_collection:
        runs-on: ubuntu-latest
        if: ${{ inputs.jest_coverage_artifact }}
        continue-on-error: true
        steps:
            - name: Download test report artifact
              uses: actions/download-artifact@v4
              with:
                name: ${{ inputs.jest_coverage_artifact }}
                path: coverage
                github-token: ${{ github.token }}
                repository: ${{ github.repository }}
                run-id: ${{ github.event.workflow_run.id }}

            - name: Check Jest coverage percentage
              run: |
                LINES=$(jq '.total.lines.pct' < ./coverage/coverage-summary.json)
                STATEMENTS=$(jq '.total.statements.pct' < ./coverage/coverage-summary.json)
                FUNCTIONS=$(jq '.total.functions.pct' < ./coverage/coverage-summary.json)
                BRANCHES=$(jq '.total.branches.pct' < ./coverage/coverage-summary.json)
        
                echo "Line coverage: $LINES%"
                echo "Statement coverage: $STATEMENTS%"
                echo "Function coverage: $FUNCTIONS%"
                echo "Branch coverage: $BRANCHES%"
        
                AVERAGE_COVERAGE=$(echo "($LINES + $STATEMENTS + $FUNCTIONS + $BRANCHES) / 4" | bc -l)
        
                echo "Average coverage: $AVERAGE_COVERAGE%"
        
                # Fail the job if the average coverage is below 80%
                if (( $(echo "$AVERAGE_COVERAGE < 80" | bc -l) )); then
                    echo "Average coverage is below 80%. Please raise test threshold."
                    #   echo "Average coverage is below 80%. Failing the job."
                    #   exit 1
                fi
            
            - name: Download lighthouse report artifact
              uses: actions/download-artifact@v4
              with:
                name: ${{ inputs.lighthouse_coverage_artifact }}
                path: lighthouse-report
                github-token: ${{ github.token }}
                repository: ${{ github.repository }}
                run-id: ${{ github.event.workflow_run.id }}
            
            - name: Check lighthouse coverage percentage
              run: |
                # Extract the coverage percentages for lines, statements, functions, and branches
                RESULTS_ACTUAL=$(jq '.[0].actual' < ./lighthouse-report/assertion-results.json)
        
                echo "Results actual: $RESULTS_ACTUAL%"
        
                # Fail the job if the average coverage is below 80%
                # if (( $(echo "$AVERAGE_COVERAGE < 80" | bc -l) )); then
                #     echo "Average coverage is below 80%. Please raise test threshold."
                #     #   echo "Average coverage is below 80%. Failing the job."
                #     #   exit 1
                # fi