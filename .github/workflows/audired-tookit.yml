name: Audi RED Toolkit

on:
  workflow_call:
    inputs:
        source_file:
            description: 'Source file from the origin directory'
            required: true
            type: string
        destination_repo:
            description: 'Destination repository'
            type: string
            required: false
            default: 'RED-Internal-Development/audi-red-documentation'
        destination_folder:
            description: 'Directory to push the file to'
            type: string
            required: false
        user_email:
            description: 'Email for the git commit'
            type: string
            required: true
        user_name:
            description: 'GitHub username for the commit'
            type: string
            required: true
        user_actor:
            description: 'GitHub username that trigged the pipeline'
            type: string
            required: true
        destination_branch:
            description: 'branch to push file to, defaults to main'
            type: string
            required: false
        destination_branch_create:
            description: 'Destination branch to create for this commit'
            type: string
            required: false
        commit_message:
            description: 'A custom message for the commit'
            type: string
            required: false
        rename:
            description: 'Rename the destination file'
            type: string
            required: false
        use_rsync:
            description: 'Copy files/directories using rsync instead of cp. Experimental feature, please know your use case'
            type: string
            required: false
        git_server:
            description: 'Git server host, default github.com'
            type: string
            required: false
            default: github.com
        enable_doc_sync:
            description: 'Enable doc sync step, DOC_SYNC_KEY is required in secrets'
            type: boolean
            required: true
        enable_scanoss:
            description: 'Enable scanoss step, SCANOSS_KEY is required in secrets'
            type: boolean
            required: true
    secrets:
        DOC_SYNC_KEY:
            required: false
            description: 'Team key used to copy files to audired'
        SCANOSS_KEY:
            required: false
            description: 'Key used to authenticate to scanoss for open source checks'

jobs:
    doc_sync:
        runs-on: ubuntu-latest
        if: ${{ inputs.enable_doc_sync }}
        steps:
        - name: Check if branch exists
          id: check_branch
          shell: bash
          run: |
            BRANCH_NAME="${{ inputs.destination_branch }}"
            DESTINATION_REPO="${{ inputs.destination_repo }}"
            API_URL="https://api.github.com/repos/${DESTINATION_REPO}/branches/${BRANCH_NAME}"

            # Query the GitHub API
            response=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${{ secrets.DOC_SYNC_KEY }}" "$API_URL")

            if [ "$response" -eq 200 ]; then
                echo "Branch '${BRANCH_NAME}' exists."
                echo "branch_exists=true" >> $GITHUB_OUTPUT
            else
                echo "Branch '${BRANCH_NAME}' does not exist."
                echo "branch_exists=false" >> $GITHUB_OUTPUT
            fi

        - name: Checkout
          uses: actions/checkout@v2
        
        - name: Eslint check for Docusaurus build compatibility
          run: npx docusaurus-mdx-checker

        - name: Pushes files from Feature App to Audi RED Portal for syndication
          uses: RED-Internal-Development/audred_docsync_action@main
          env:
            API_TOKEN_GITHUB: ${{ secrets.DOC_SYNC_KEY }}
          with:
            source_file: ${{ inputs.source_file }}
            destination_repo: ${{ inputs.destination_repo }}
            destination_folder: ${{ inputs.destination_folder }}
            destination_branch: ${{ inputs.destination_branch }}
            user_email: ${{ inputs.user_email }}
            user_name: ${{ inputs.user_name }}
            user_actor: ${{ github.actor }}
            destination_branch_exists: ${{ steps.check_branch.outputs.branch_exists }}

    scanoss:
        runs-on: ubuntu-latest
        if: ${{ inputs.enable_scanoss }}
        env:
            SCANOSS_KEY: ${{ secrets.SCANOSS_KEY }}
        steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Run SCANOSS Code Scan
          id: scanoss-code-scan-step
          uses: scanoss/gha-code-scan@v0.2.0
          with:
            api.key: ${{ secrets.SCANOSS_KEY }}
            api.url: https://api.scanoss.com/scan/direct
            dependencies.enabled: true
            policies.halt_on_failure: false
            policies: copyleft, undeclared